image: "10.0.0.215:5001/crazy_bee/web:0.1"
stages:
    - deploy_doc
    - unit_test
    - pep8
    - deploy_web

before_script:
    - echo "https://mirror.tuna.tsinghua.edu.cn/alpine/v3.4/main" > /etc/apk/repositories
    - 'which ssh-agent || ( apk update && apk add openssh-client git )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan "$DEPLOY_SERVER" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

variables:
  DJANGO_SETTINGS_MODULE: 'crazy_bee.settings.test'

deploy-doc:
    stage: deploy_doc
    script:
        # 连接远程服务器并拉取代码、执行部署脚本cc
        - ssh $USER@$DEPLOY_SERVER "cd ~/crazy_bee && git pull origin dev && ./start.sh deploy_doc"
    only:
        - dev

unit_test:
    stage: unit_test
    script:
        # --omit 排除对指定文件的测试  --source指定要扫描的文件
        - coverage run --omit='*/__init__.py' --source='.' manage.py test
        - coverage report

pep8:
    stage: pep8
    script:
        # - python -m flake8 './src/mathartsys/tests' './src/mathartsys/db_model' './src/mathartsys/model/gps' './src/mathartsys/model/running_rate'
        - python -m flake8 '.' --exclude */migrations
    allow_failure: true

deploy_web:
    stage: deploy_web
    # services:
    #     - name: mysql:5.6
    #       alias: mysql
    #     - name: redis:4
    #       alias: redis
    script:
        - ssh $USER@$DEPLOY_SERVER "cd ~/crazy_bee && git pull origin dev && ./start.sh deploy 0.0.0.0:8000"
    only:
        - dev
